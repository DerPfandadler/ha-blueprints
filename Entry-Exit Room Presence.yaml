blueprint:
  name: Room Presence with Area Light Control
  description: >
    Monitors esphome entry/exit events for a designated area.
    Increments/decrements a counter, sets a presence input_boolean,
    and when the room is unoccupied, turns off all lights in the specified area.
  domain: automation
  input:
    area:
      name: Room Area
      description: "The area to monitor for presence detection and control its lights."
      selector:
        area: {}
    counter_entity:
      name: Counter Entity
      description: "Counter entity tracking the number of people in the area."
      selector:
        entity:
          domain: counter
    presence_entity:
      name: Presence Input Boolean
      description: "Input boolean that represents the occupancy status of the area."
      selector:
        entity:
          domain: input_boolean

trigger:
  - platform: event
    event_type: esphome.entry_detected
  - platform: event
    event_type: esphome.exit_detected

variables:
  monitored_area: !input area
  counter: !input counter_entity
  presence: !input presence_entity

condition:
  # Ensure the event's room matches the selected area name
  - condition: template
    value_template: "{{ trigger.event.data.room == monitored_area }}"

action:
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ trigger.event.event_type == 'esphome.entry_detected' }}"
        sequence:
          - service: counter.increment
            target:
              entity_id: "{{ counter }}"
          - service: input_boolean.turn_on
            target:
              entity_id: "{{ presence }}"
      - conditions:
          - condition: template
            value_template: "{{ trigger.event.event_type == 'esphome.exit_detected' }}"
        sequence:
          - service: counter.decrement
            target:
              entity_id: "{{ counter }}"
          - delay: "00:00:01"
          - condition: template
            value_template: "{{ states(counter) | int <= 0 }}"
          - service: input_boolean.turn_off
            target:
              entity_id: "{{ presence }}"
          - service: homeassistant.turn_off
            target:
              area_id: !input area